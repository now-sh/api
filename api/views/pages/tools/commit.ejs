<div class="hero fade-in">
    <h1>Git Commit Message Generator</h1>
    <p class="lead">Get random commit messages for your git commits</p>
</div>

<div class="card">
    <h2>Random Commit Message</h2>
    <p class="text-secondary mb-4">Click the button to generate a random commit message from our collection.</p>
    
    <div id="messageDisplay" class="message-display" style="display: none;">
        <div class="result-output" id="commitMessage"></div>
        <button class="btn btn-sm btn-secondary copy-btn" data-action="copy-message">Copy</button>
    </div>
    
    <button id="generateBtn" class="btn btn-primary btn-lg">Generate New Message</button>
    
    <div class="mt-4">
        <button id="showAllBtn" class="btn btn-secondary btn-sm">Show Random Messages</button>
    </div>
</div>

<div class="card mt-6" id="allMessagesCard" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Random Messages</h3>
        <span id="messageStats" class="badge bg-purple"></span>
    </div>
    <div id="allMessagesList" class="messages-list">
        <div class="loading">Loading messages...</div>
    </div>
    <div class="pagination-controls mt-4" style="display: none;">
        <button id="loadMoreBtn" class="btn btn-primary">Load More (50)</button>
        <span class="text-muted ms-3" id="loadedCount"></span>
    </div>
</div>

<div class="card mt-6">
    <h3>CLI Usage</h3>
    <p>You can use this API directly from your terminal:</p>
    
    <div class="code-block">
        <h4>Get a random commit message:</h4>
        <pre><code>curl -q -LSsf <%= baseUrl %>/api/v1/tools/commit/text</code></pre>
    </div>
    
    <div class="code-block">
        <h4>Create a git alias:</h4>
        <pre><code>git config --global alias.random-commit '!f() { git commit -m "$(curl -q -LSsf <%= baseUrl %>/api/v1/tools/commit/text)"; }; f'</code></pre>
        <p class="text-secondary">Then use: <code>git random-commit</code></p>
    </div>
    
    <div class="code-block">
        <h4>Bash function:</h4>
        <pre><code>commit_random() {
    git commit -m "$(curl -q -LSsf <%= baseUrl %>/api/v1/tools/commit/text)" "$@"
}</code></pre>
        <p class="text-secondary">Add to your <code>~/.bashrc</code> or <code>~/.zshrc</code></p>
    </div>
</div>

<style>
.message-display {
    position: relative;
    margin-bottom: var(--space-4);
}

.result-output {
    padding: var(--space-4);
    background-color: var(--bg-secondary);
    border: 2px solid var(--green);
    border-radius: var(--radius-md);
    font-size: var(--text-lg);
    font-family: 'Monaco', 'Consolas', monospace;
    word-wrap: break-word;
}

.copy-btn {
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
}

.messages-list {
    max-height: 400px;
    overflow-y: auto;
    display: grid;
    gap: var(--space-2);
}

.message-item {
    padding: var(--space-3);
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-family: 'Monaco', 'Consolas', monospace;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.message-item:hover {
    border-color: var(--purple);
    transform: translateX(4px);
}

.message-item .copy-icon {
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.message-item:hover .copy-icon {
    opacity: 1;
}

.code-block {
    margin-bottom: var(--space-4);
}

.code-block h4 {
    font-size: var(--text-base);
    margin-bottom: var(--space-2);
    color: var(--text-secondary);
}

.code-block pre {
    background-color: var(--bg-secondary);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    overflow-x: auto;
}

.code-block code {
    color: var(--cyan);
}

.loading {
    text-align: center;
    padding: var(--space-4);
    color: var(--text-secondary);
}

.btn-lg {
    padding: var(--space-3) var(--space-6);
    font-size: var(--text-lg);
}

.pagination-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
}

.badge.bg-purple {
    background-color: var(--purple);
    color: var(--background);
    font-size: var(--text-sm);
    padding: 0.5rem 1rem;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-display {
    animation: fadeIn 0.3s ease;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const showAllBtn = document.getElementById('showAllBtn');
    const messageDisplay = document.getElementById('messageDisplay');
    const commitMessage = document.getElementById('commitMessage');
    const allMessagesCard = document.getElementById('allMessagesCard');
    const allMessagesList = document.getElementById('allMessagesList');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const messageStats = document.getElementById('messageStats');
    const loadedCount = document.getElementById('loadedCount');
    const paginationControls = document.querySelector('.pagination-controls');

    let allMessages = [];
    let currentPage = 0;
    const messagesPerPage = 50;

    // Function to generate random message
    async function generateMessage() {
        try {
            const response = await fetch('/api/v1/tools/commit');
            const data = await response.json();
            
            if (response.ok && data.success && data.data) {
                commitMessage.textContent = data.data.message;
                messageDisplay.style.display = 'block';
                
                // Auto-select for easy copying
                const range = document.createRange();
                range.selectNodeContents(commitMessage);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                commitMessage.textContent = 'Error generating message';
                messageDisplay.style.display = 'block';
            }
        } catch (error) {
            commitMessage.textContent = 'Network error. Please try again.';
            messageDisplay.style.display = 'block';
        }
    }

    // Generate message on button click
    generateBtn.addEventListener('click', generateMessage);

    // Auto-generate message on page load
    generateMessage();

    // Function to render messages
    function renderMessages(startIndex, count) {
        const endIndex = Math.min(startIndex + count, allMessages.length);
        const messagesToRender = allMessages.slice(startIndex, endIndex);

        const messagesHtml = messagesToRender.map((msg, index) => `
            <div class="message-item" data-message="${escapeHtml(msg)}">
                ${escapeHtml(msg)}
                <span class="copy-icon">ðŸ“‹</span>
            </div>
        `).join('');

        if (startIndex === 0) {
            allMessagesList.innerHTML = messagesHtml;
        } else {
            allMessagesList.insertAdjacentHTML('beforeend', messagesHtml);
        }

        // Add click handlers for copying
        document.querySelectorAll('.message-item').forEach(item => {
            item.addEventListener('click', () => {
                const message = item.getAttribute('data-message');
                copyToClipboard(message, item);
            });
        });

        // Update stats
        loadedCount.textContent = `Showing ${endIndex} of ${allMessages.length} messages`;

        // Show/hide load more button
        if (endIndex >= allMessages.length) {
            loadMoreBtn.style.display = 'none';
        } else {
            loadMoreBtn.style.display = 'inline-block';
        }
    }

    // Show messages
    showAllBtn.addEventListener('click', async () => {
        if (allMessagesCard.style.display === 'block') {
            allMessagesCard.style.display = 'none';
            showAllBtn.textContent = 'Show Random Messages';
            currentPage = 0;
            return;
        }

        try {
            allMessagesList.innerHTML = '<div class="loading">Loading messages...</div>';
            allMessagesCard.style.display = 'block';
            showAllBtn.textContent = 'Hide Messages';

            const response = await fetch('/api/v1/tools/commit/batch/200');
            const data = await response.json();

            if (response.ok && data.success && data.data) {
                allMessages = data.data.messages;
                messageStats.textContent = `${data.data.total} total available`;
                currentPage = 0;

                renderMessages(0, messagesPerPage);
                paginationControls.style.display = 'block';
            }
        } catch (error) {
            allMessagesList.innerHTML = '<div class="error">Failed to load messages</div>';
        }
    });

    // Load more messages
    loadMoreBtn.addEventListener('click', () => {
        currentPage++;
        renderMessages(currentPage * messagesPerPage, messagesPerPage);
    });
    
    // Copy button handler
    document.addEventListener('click', (e) => {
        if (e.target.matches('[data-action="copy-message"]')) {
            const message = commitMessage.textContent;
            copyToClipboard(message, e.target);
        }
    });
    
    // HTML escape function
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Copy to clipboard function
    function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
            const originalText = element.textContent;
            const isButton = element.tagName === 'BUTTON';
            
            if (isButton) {
                element.textContent = 'Copied!';
                element.classList.add('btn-success');
                
                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('btn-success');
                }, 2000);
            } else {
                // For message items, show brief feedback
                const originalBg = element.style.backgroundColor;
                element.style.backgroundColor = 'var(--green)';
                element.style.color = 'var(--background)';
                
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                    element.style.color = '';
                }, 300);
            }
        }).catch(() => {
            // Fallback
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            if (element.tagName === 'BUTTON') {
                element.textContent = 'Copied!';
                setTimeout(() => {
                    element.textContent = 'Copy';
                }, 2000);
            }
        });
    }
});
</script>