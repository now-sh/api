<div class="hero fade-in">
    <h1>API Version & Status</h1>
    <p class="lead">Real-time API version information and system status</p>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <!-- Loading State -->
        <div id="loadingState" class="card mb-4">
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Loading system status...</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="card mb-4" style="display: none;">
            <div class="error-container">
                <span class="error-icon">!</span>
                <h3>Unable to load system status</h3>
                <p id="errorMessage">Please try again later.</p>
                <button class="btn btn-primary" onclick="loadVersionData()">Retry</button>
            </div>
        </div>

        <!-- Content (hidden until loaded) -->
        <div id="versionContent" style="display: none;">
            <!-- Greeting Banner -->
            <div id="greetingBanner" class="greeting-banner mb-4" style="display: none;"></div>

            <!-- Health Status -->
            <div class="card mb-4">
                <h2 class="card-title">Health Status</h2>
                <div id="healthStatus" class="health-status"></div>
            </div>

            <!-- Version Information -->
            <div class="card mb-4">
                <h2 class="card-title">Version Information</h2>
                <div id="versionInfo" class="info-grid"></div>
            </div>

            <!-- Database Status -->
            <div class="card mb-4">
                <h2 class="card-title">Database Status</h2>
                <div id="databaseStatus" class="database-status"></div>
            </div>

            <!-- API Keys Status -->
            <div class="card mb-4">
                <h2 class="card-title">API Keys Status</h2>
                <div id="apiKeysStatus" class="info-grid"></div>
            </div>

            <!-- External Data Sources -->
            <div class="card mb-4">
                <h2 class="card-title">External Data Sources</h2>
                <div id="dataSources" class="info-grid"></div>
            </div>

            <!-- System Information -->
            <div class="card mb-4">
                <h2 class="card-title">System Information</h2>
                <div id="systemInfo" class="info-grid"></div>
            </div>

            <!-- Environment -->
            <div class="card mb-4">
                <h2 class="card-title">Environment</h2>
                <div id="environmentInfo" class="info-grid"></div>
            </div>

            <!-- Proxy Configuration -->
            <div class="card mb-4">
                <h2 class="card-title">Proxy Configuration</h2>
                <div id="proxyConfig" class="proxy-list"></div>
            </div>

            <!-- Last Updated -->
            <div class="text-center text-muted mt-4">
                <small>Last updated: <span id="lastUpdated">-</span></small>
                <button class="btn btn-sm btn-outline-primary ms-3" onclick="loadVersionData()">
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadVersionData();
});

async function loadVersionData() {
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const versionContent = document.getElementById('versionContent');

    loadingState.style.display = 'block';
    errorState.style.display = 'none';
    versionContent.style.display = 'none';

    try {
        const response = await fetch('/api/v1/version');
        const data = await response.json();

        if (!response.ok && !data.Health) {
            throw new Error(data.error || 'Failed to load version data');
        }

        renderVersionData(data);
        loadingState.style.display = 'none';
        versionContent.style.display = 'block';
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
    } catch (error) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

function renderVersionData(data) {
    // Greeting Banner
    if (data.Greetings) {
        const banner = document.getElementById('greetingBanner');
        banner.textContent = data.Greetings;
        banner.style.display = 'block';
    }

    // Health Status
    const healthDiv = document.getElementById('healthStatus');
    if (data.Health) {
        const statusClass = data.Health.Status === 'healthy' ? 'success' :
                          data.Health.Status === 'degraded' ? 'warning' : 'error';
        healthDiv.innerHTML = `
            <div class="status-indicator ${statusClass}">
                <span class="status-dot"></span>
                <span class="status-text">${data.Health.Status}</span>
            </div>
            ${data.Health.Issues && data.Health.Issues.length > 0 ? `
                <div class="issues-list mt-3">
                    <strong>Issues:</strong>
                    <ul>
                        ${data.Health.Issues.map(issue => `<li class="text-warning">${issue}</li>`).join('')}
                    </ul>
                </div>
            ` : '<p class="text-success mt-2">No issues detected</p>'}
        `;
    } else {
        healthDiv.innerHTML = '<p class="text-muted">Health information not available</p>';
    }

    // Version Information
    const versionDiv = document.getElementById('versionInfo');
    versionDiv.innerHTML = `
        <div class="info-item">
            <span class="info-label">API Version</span>
            <span class="info-value">${data.Version || 'Unknown'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Time Zone</span>
            <span class="info-value">${data.TimeZone || 'Unknown'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Current Time</span>
            <span class="info-value">${data.Time || 'Unknown'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Today</span>
            <span class="info-value">${data.Today || 'Unknown'}</span>
        </div>
    `;

    // Database Status
    const dbDiv = document.getElementById('databaseStatus');
    if (data.Database) {
        const dbStatusClass = data.Database.Status === 'Connected' ? 'success' : 'error';
        dbDiv.innerHTML = `
            <div class="status-indicator ${dbStatusClass}">
                <span class="status-dot"></span>
                <span class="status-text">${data.Database.Status}</span>
            </div>
            ${data.Database.Details ? `
                <div class="info-grid mt-3">
                    <div class="info-item">
                        <span class="info-label">State</span>
                        <span class="info-value">${data.Database.Details.State || 'Unknown'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Configured</span>
                        <span class="info-value">${data.Database.Details.Configured ? 'Yes' : 'No'}</span>
                    </div>
                </div>
            ` : ''}
        `;
    } else {
        dbDiv.innerHTML = '<p class="text-muted">Database information not available</p>';
    }

    // API Keys Status
    const apiKeysDiv = document.getElementById('apiKeysStatus');
    if (data.APIKeys) {
        apiKeysDiv.innerHTML = Object.entries(data.APIKeys).map(([key, value]) => `
            <div class="info-item">
                <span class="info-label">${key}</span>
                <span class="info-value ${value === 'Configured ✓' ? 'success' : 'warning'}">${value}</span>
            </div>
        `).join('');
    } else {
        apiKeysDiv.innerHTML = '<p class="text-muted">API keys information not available</p>';
    }

    // Data Sources
    const sourcesDiv = document.getElementById('dataSources');
    if (data.DataSources) {
        sourcesDiv.innerHTML = Object.entries(data.DataSources).map(([key, value]) => `
            <div class="info-item">
                <span class="info-label">${key}</span>
                <span class="info-value ${value === 'Not Configured' ? 'warning' : ''}">${value}</span>
            </div>
        `).join('');
    } else {
        sourcesDiv.innerHTML = '<p class="text-muted">Data sources information not available</p>';
    }

    // System Information
    const systemDiv = document.getElementById('systemInfo');
    if (data.System) {
        systemDiv.innerHTML = `
            <div class="info-item">
                <span class="info-label">Node Version</span>
                <span class="info-value">${data.System.NodeVersion || 'Unknown'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Platform</span>
                <span class="info-value">${data.System.Platform || 'Unknown'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Architecture</span>
                <span class="info-value">${data.System.Architecture || 'Unknown'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Uptime</span>
                <span class="info-value">${data.System.Uptime || 'Unknown'}</span>
            </div>
            ${data.System.Memory ? `
                <div class="info-item">
                    <span class="info-label">Heap Memory</span>
                    <span class="info-value">${data.System.Memory.HeapUsed} / ${data.System.Memory.HeapTotal}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Heap Usage</span>
                    <span class="info-value">${data.System.Memory.HeapPercentage}</span>
                </div>
            ` : ''}
            ${data.System.CPUs ? `
                <div class="info-item">
                    <span class="info-label">CPUs</span>
                    <span class="info-value">${data.System.CPUs}</span>
                </div>
            ` : ''}
        `;
    } else {
        systemDiv.innerHTML = '<p class="text-muted">System information not available</p>';
    }

    // Environment
    const envDiv = document.getElementById('environmentInfo');
    if (data.Environment) {
        envDiv.innerHTML = `
            <div class="info-item">
                <span class="info-label">Node Environment</span>
                <span class="info-value">${data.Environment.NodeEnv || 'Unknown'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Port</span>
                <span class="info-value">${data.Environment.Port || 'Unknown'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Running on Vercel</span>
                <span class="info-value">${data.Environment.IsVercel || 'Unknown'}</span>
            </div>
            ${data.Environment.Region && data.Environment.Region !== 'N/A' ? `
                <div class="info-item">
                    <span class="info-label">Region</span>
                    <span class="info-value">${data.Environment.Region}</span>
                </div>
            ` : ''}
        `;
    } else {
        envDiv.innerHTML = '<p class="text-muted">Environment information not available</p>';
    }

    // Proxy Configuration
    const proxyDiv = document.getElementById('proxyConfig');
    if (data.Proxies && Object.keys(data.Proxies).length > 0) {
        proxyDiv.innerHTML = Object.entries(data.Proxies).map(([name, config]) => `
            <div class="proxy-item">
                <span class="proxy-path">${name}</span>
                <span class="proxy-arrow">→</span>
                <span class="proxy-target">${config.target || config}</span>
                ${config.status ? `<span class="badge bg-success ms-2">${config.status}</span>` : ''}
            </div>
        `).join('');
    } else {
        proxyDiv.innerHTML = '<p class="text-muted">No proxy configuration available</p>';
    }
}
</script>

<style>
.loading-container {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border-color);
    border-top-color: var(--purple);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-container {
    text-align: center;
    padding: 3rem;
}

.error-icon {
    display: inline-flex;
    width: 60px;
    height: 60px;
    background-color: var(--red);
    color: white;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 1rem;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.info-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    color: var(--text-primary);
    font-size: 1.125rem;
}

.info-value.success {
    color: var(--green);
    font-weight: 600;
}

.info-value.warning {
    color: var(--yellow);
}

.info-value.error {
    color: var(--red);
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-indicator.success .status-dot { background-color: var(--green); }
.status-indicator.error .status-dot { background-color: var(--red); }
.status-indicator.warning .status-dot { background-color: var(--yellow); }
.status-indicator.success .status-text { color: var(--green); }
.status-indicator.error .status-text { color: var(--red); }
.status-indicator.warning .status-text { color: var(--yellow); }

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 currentColor; }
    70% { box-shadow: 0 0 0 10px transparent; }
    100% { box-shadow: 0 0 0 0 transparent; }
}

.issues-list ul {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
}

.proxy-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.proxy-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    background-color: var(--bg-secondary);
    padding: 1rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
}

.proxy-path {
    color: var(--cyan);
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.875rem;
}

.proxy-arrow {
    color: var(--text-secondary);
}

.proxy-target {
    color: var(--purple);
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.875rem;
}

.greeting-banner {
    background: linear-gradient(135deg, var(--purple) 0%, var(--cyan) 100%);
    color: white;
    padding: 1rem;
    border-radius: var(--radius-md);
    text-align: center;
    font-weight: 600;
}

@media (max-width: 768px) {
    .info-grid {
        grid-template-columns: 1fr;
    }

    .proxy-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}
</style>
